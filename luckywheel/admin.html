<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lucky Draw Admin</title>
<style>
  :root{
    --bg1:#120a2a; --bg2:#1a2c6b;
    --card:rgba(255,255,255,.08);
    --stroke:rgba(255,255,255,.12);
    --gold1:#ffcc55; --gold2:#ff8a00;
    --txt:#e9ecff; --muted:rgba(233,236,255,.7);
    --ok:#27d17f; --bad:#ff4d4d;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--txt);
    background: radial-gradient(1200px 700px at 20% 20%, #6b2cff 0%, transparent 45%),
                radial-gradient(900px 600px at 80% 30%, #2b6cff 0%, transparent 55%),
                linear-gradient(135deg, var(--bg1), var(--bg2));
    min-height:100vh;
  }
  header{
    height:64px; display:flex; align-items:center; justify-content:space-between;
    padding:0 18px;
    background:linear-gradient(90deg, rgba(0,0,0,.45), rgba(0,0,0,.15));
    border-bottom:1px solid var(--stroke);
    backdrop-filter: blur(10px);
  }
  .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.5px}
  .dot{width:12px; height:12px; border-radius:999px; background:linear-gradient(90deg,var(--gold1),var(--gold2)); box-shadow:0 0 18px rgba(255,170,0,.55)}
  nav a{color:var(--muted); text-decoration:none; margin-left:14px; font-weight:600}
  nav a:hover{color:var(--txt)}
  .wrap{max-width:1150px; margin:22px auto; padding:0 16px}
  .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px}
  .card{
    background:var(--card); border:1px solid var(--stroke); border-radius:16px;
    box-shadow: 0 18px 50px rgba(0,0,0,.35);
    backdrop-filter: blur(12px);
    overflow:hidden;
  }
  .card h3{margin:0; padding:14px 16px; border-bottom:1px solid var(--stroke); display:flex; align-items:center; gap:10px}
  .card .body{padding:16px}
  label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
  input, select{
    width:100%; padding:12px 12px; border-radius:12px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(0,0,0,.22);
    color:var(--txt); outline:none;
  }
  input:focus, select:focus{border-color:rgba(255,200,85,.6); box-shadow:0 0 0 3px rgba(255,180,0,.15)}
  .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
  .toggle{
    display:flex; gap:10px; margin-top:10px;
  }
  .pill{
    flex:1; padding:11px 12px; border-radius:12px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(0,0,0,.18);
    color:var(--muted); font-weight:800; cursor:pointer;
    display:flex; align-items:center; justify-content:center; gap:8px;
  }
  .pill.active{
    background:rgba(40,110,255,.22);
    border-color:rgba(40,110,255,.55);
    color:var(--txt);
  }
  .btn{
    width:100%; margin-top:14px;
    padding:12px 14px; border-radius:12px; border:none;
    font-weight:900; cursor:pointer; color:#081022;
    background:linear-gradient(90deg,var(--ok),#18b86e);
    box-shadow:0 10px 24px rgba(0,0,0,.25);
  }
  .btn:active{transform:translateY(1px)}
  .codeBox{
    border-radius:14px; padding:14px; border:1px solid var(--stroke);
    background:rgba(0,0,0,.18);
  }
  .bigCode{font-size:28px; font-weight:1000; letter-spacing:2px; margin:4px 0 2px}
  .sub{color:var(--muted); font-size:12px}
  .btn2{
    margin-top:10px; width:100%;
    padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.16);
    background:rgba(0,0,0,.18); color:var(--txt); font-weight:800; cursor:pointer;
  }
  .btn2:hover{border-color:rgba(255,200,85,.5)}
  .tableWrap{overflow:auto}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th,td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.10); text-align:left; white-space:nowrap}
  th{color:var(--muted); font-weight:800}
  .tag{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 10px; border-radius:999px; font-size:12px; font-weight:900;
    border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.2)
  }
  .tag.ok{border-color:rgba(39,209,127,.35); color:#bff7dc}
  .tag.bad{border-color:rgba(255,77,77,.35); color:#ffd0d0}
  .tag.warn{border-color:rgba(255,200,85,.35); color:#ffe7b5}
  .mini{
    display:flex; gap:10px; align-items:center; justify-content:space-between;
    margin-top:10px;
  }
  .toast{
    position:fixed; right:16px; bottom:16px;
    background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.14);
    backdrop-filter:blur(10px);
    padding:10px 12px; border-radius:12px; color:var(--txt);
    display:none; max-width:360px;
  }
  .headLeft{display:flex;align-items:center;gap:12px}
.menuBtn{
  width:44px;height:44px;border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.18);
  color:#fff;font-size:20px;cursor:pointer;
}
.menuBtn:hover{filter:brightness(1.1)}

.sideOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,.45);
  display:none;z-index:80;
}
.sidebar{
  position:fixed;top:0;left:0;height:100vh;width:320px;
  transform:translateX(-110%);
  transition:transform .25s ease;
  background:rgba(12,16,40,.92);
  border-right:1px solid rgba(255,255,255,.12);
  backdrop-filter:blur(14px);
  z-index:90;
  padding:14px;
}
.sidebar.show{transform:translateX(0)}
.sideHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.sideTitle{font-size:16px;font-weight:900}
.sideClose{
  width:38px;height:38px;border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);color:#fff;cursor:pointer
}
.sideItem{
  width:100%;padding:12px 12px;border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
  color:#fff;font-weight:800;cursor:pointer;
  text-align:left;margin-top:10px;
}

/* Prize Modal */
.modalOverlay{
  position:fixed;inset:0;display:none;place-items:center;
  background:rgba(0,0,0,.55);z-index:100;
}
.modalCard{
  width:min(520px,92vw);
  background:rgba(18,22,56,.92);
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  box-shadow:0 20px 60px rgba(0,0,0,.45);
  backdrop-filter:blur(14px);
  overflow:hidden;
}
.modalHead{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10);
}
.modalTitle{font-weight:900}
.modalX{
  width:36px;height:36px;border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:#fff;cursor:pointer;
}
.modalBody{padding:14px 16px}
.modalFoot{
  padding:12px 16px;display:flex;justify-content:flex-end;gap:10px;
  border-top:1px solid rgba(255,255,255,.10);
}
.tabsRow{display:flex;gap:10px;margin-bottom:10px}
.tabBtn{
  flex:1;padding:10px;border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:#fff;font-weight:900;cursor:pointer;
}
.tabBtn.active{
  background:linear-gradient(90deg, rgba(255,210,102,.35), rgba(255,120,72,.25));
  border-color:rgba(255,210,102,.35);
}
.pillRow{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0}
.pillTag{
  display:flex;align-items:center;gap:8px;
  padding:10px 12px;border-radius:999px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.10);
  font-weight:900;color:#fff;
}
.pillTag button{
  width:26px;height:26px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.20);
  color:#fff;cursor:pointer;font-weight:900;
}
.addRow{display:flex;gap:10px;margin-top:10px}
.addRow input{
  flex:1;padding:12px;border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.18);color:#fff;
  outline:none;
}
/* ===== HISTORY: max 15 rows, scroll ===== */
#history .tableWrap{
  max-height: calc(15 * 46px); /* 15 row, adjust kalau row tinggi */
  overflow: auto;
  border-radius: 14px;
}

/* sticky header bila scroll */
#history .tableWrap thead th{
  position: sticky;
  top: 0;
  z-index: 2;
  background: linear-gradient(90deg, rgba(30,40,110,.95), rgba(25,35,95,.95));
  backdrop-filter: blur(10px);
}

/* cantikkan scrollbar */
#history .tableWrap::-webkit-scrollbar{ width: 10px; height:10px; }
#history .tableWrap::-webkit-scrollbar-track{
  background: rgba(255,255,255,.06);
  border-radius: 999px;
}
#history .tableWrap::-webkit-scrollbar-thumb{
  background: linear-gradient(180deg, rgba(255,77,216,.75), rgba(106,64,255,.75));
  border-radius: 999px;
  border: 2px solid rgba(0,0,0,.25);
}
#history .tableWrap{ scrollbar-width: thin; scrollbar-color: rgba(255,77,216,.75) rgba(255,255,255,.06); }

/* delete button */
.btnDel{
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,80,80,.12);
  color: rgba(255,210,210,.95);
  font-weight: 900;
  cursor: pointer;
}
.btnDel:hover{ background: rgba(255,80,80,.20); }
.btnDel:active{ transform: translateY(1px); }
</style>
</head>
<body>
<header>
  <div class="headLeft">
    <button id="btnMenu" class="menuBtn">‚ò∞</button>
    <div class="brand"><span class="dot"></span> LUCKY DRAW <span style="opacity:.6;font-weight:700">ADMIN</span></div>
  </div>

  <nav>
    <a href="user.html">Home</a>
    <a href="#codes">Codes</a>
    <a href="#history">History</a>
  </nav>
</header>

<!-- Sidebar overlay -->
<div id="sideOverlay" class="sideOverlay"></div>

<!-- Sidebar -->
<aside id="sidebar" class="sidebar">
  <div class="sideHead">
    <div class="sideTitle">Menu</div>
    <button id="btnSideClose" class="sideClose">‚úï</button>
  </div>

  <button class="sideItem" id="sidePrize">üèÜ Prize Settings</button>
</aside>

<!-- Prize Modal -->
<div id="prizeOverlay" class="modalOverlay">
  <div class="modalCard">
    <div class="modalHead">
      <div class="modalTitle">Prize Settings</div>
      <button id="prizeX" class="modalX">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="tabsRow">
        <button id="tabNormal" class="tabBtn active">NORMAL</button>
        <button id="tabSuper" class="tabBtn">SUPER</button>
      </div>

      <div class="pillRow" id="prizePills"></div>

      <div class="addRow">
        <input id="prizeInput" type="number" placeholder="Add prize (e.g. 100)" />
        <button id="prizeAdd" class="btn2">+ Add</button>
      </div>

      <small style="opacity:.75;display:block;margin-top:10px;">
        Tambah/remove prize di sini. Tekan Save untuk simpan ke Firebase.
      </small>
    </div>

    <div class="modalFoot">
      <button id="prizeCancel" class="btn2">Cancel</button>
      <button id="prizeSave" class="btn">Save</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <h3>üéüÔ∏è Generate Promo Code</h3>
      <div class="body">
        <label>Customer Name/ID (optional)</label>
        <input id="customer" placeholder="Example: SK0015 B20"/>

        <div class="toggle">
          <button class="pill active" id="typeNormal">üéØ NORMAL PRIZE</button>
          <button class="pill" id="typeSuper">‚≠ê SUPER PRIZE</button>
        </div>

        <label>Select Prize (Points)</label>
        <select id="points"></select>

        <div class="row">
          <div>
            <label>Expiration Time (hours)</label>
            <input id="expHours" type="number" min="1" value="24"/>
          </div>
          <div>
            <label>Usage Limit</label>
            <input id="usageLimit" type="number" min="1" value="1"/>
          </div>
        </div>

        <button class="btn" id="btnGenerate">Ôºã Generate Promo Code</button>
      </div>
    </div>

    <div class="card">
      <h3>‚úÖ Generated Code</h3>
      <div class="body">
        <div class="codeBox">
          <div class="sub">Your code</div>
          <div class="bigCode" id="genCode">‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî</div>
          <div class="sub" id="genMeta">Generate a code to see details.</div>
          <button class="btn2" id="btnCopy" disabled>üìã Copy Code</button>
        </div>

        <div class="mini">
          <div class="sub">Tip: share user page link + code</div>
          <button class="btn2" id="btnOpenUser">Open User Page ‚Üó</button>
        </div>
      </div>
    </div>
  </div>

  <div style="height:16px"></div>

  <div class="card" id="codes">
    <h3>üßæ Active Promo Codes</h3>
    <div class="body">
      <div class="row">
        <input id="searchCode" placeholder="Search by code / customer..."/>
        <button class="btn2" id="btnRefresh">‚Üª Refresh</button>
      </div>
      <div class="tableWrap" style="margin-top:10px">
        <table>
          <thead>
            <tr>
              <th>Code</th>
              <th>Customer</th>
              <th>Prize</th>
              <th>Type</th>
              <th>Used</th>
              <th>Limit</th>
              <th>Expires</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="codesTbody">
            <tr><td colspan="8" style="color:rgba(233,236,255,.65)">No data yet.</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div style="height:16px"></div>

  <div class="card" id="history">
    <h3>üìú Redemption History</h3>
    <div class="body">
      <div class="row">
        <input id="searchHist" placeholder="Search by code / userId..."/>
        <button class="btn2" id="btnClearView">Clear Filter</button>
      </div>
      <div class="tableWrap" style="margin-top:10px">
        <table>
<thead>
  <tr>
    <th>Code</th>
    <th>Points</th>
    <th>User</th>
    <th>Redeemed At</th>
    <th style="width:110px;text-align:right;">Actions</th>
  </tr>
</thead>
<tbody id="histTbody">
  <tr><td colspan="5" style="color:rgba(233,236,255,.65)">No history yet.</td></tr>
</tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<!-- Firebase v9 (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getDatabase, ref, set, get, child, onValue, query, limitToLast,remove
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDSqpbnkb3GLNFlHLYSz5XyRYPvKLAOCOA",
  authDomain: "lucky-spined.firebaseapp.com",
  databaseURL: "https://lucky-spined-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "lucky-spined",
  storageBucket: "lucky-spined.firebasestorage.app",
  messagingSenderId: "708886212396",
  appId: "1:708886212396:web:2cb7a900fe1a7891510689"
};

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ===== UI helpers =====
  const $ = (id)=>document.getElementById(id);
  const toast = (msg)=>{
    $("toast").textContent = msg;
    $("toast").style.display="block";
    clearTimeout(window.__t);
    window.__t = setTimeout(()=> $("toast").style.display="none", 2200);
  };

function cleanPrizeList(arr){
  return (arr || [])
    .map(v => Number(v))
    .filter(v => Number.isFinite(v) && v > 0)
    .filter((v,i,a) => a.indexOf(v) === i)
    .sort((a,b)=>a-b);
}
// ===== Prize settings in Firebase =====
const PRIZES_REF = ref(db, "settings/prizes");

// default kalau Firebase kosong
let prizeConfig = {
  NORMAL: [3, 6, 9, 12, 15, 18],
  SUPER:  [20, 25, 30, 35, 40, 88]
};

async function loadPrizeConfig(){
  const snap = await get(PRIZES_REF);

  if(snap.exists()){
    const v = snap.val() || {};
    prizeConfig = {
      NORMAL: cleanPrizeList(v.NORMAL ?? prizeConfig.NORMAL),
      SUPER:  cleanPrizeList(v.SUPER  ?? prizeConfig.SUPER)
    };
  }else{
    // pastikan default pun bersih sebelum simpan
    prizeConfig = {
      NORMAL: cleanPrizeList(prizeConfig.NORMAL),
      SUPER:  cleanPrizeList(prizeConfig.SUPER)
    };
    await set(PRIZES_REF, prizeConfig);
  }
}

// Render dropdown points ikut prizeConfig
function renderPointsOptions(type){
  const list = (prizeConfig[type] || []).slice().sort((a,b)=>a-b);
  const sel = $("points");
  sel.innerHTML = list.map(p => `<option value="${p}">FREE ${p}</option>`).join("");
  if(list.length) sel.value = String(list[0]);
}

// Prize type toggle
let prizeType = "NORMAL";

await loadPrizeConfig();
renderPointsOptions(prizeType);

$("typeNormal").onclick = ()=>{
  prizeType="NORMAL";
  $("typeNormal").classList.add("active");
  $("typeSuper").classList.remove("active");
  renderPointsOptions(prizeType);
};

$("typeSuper").onclick = ()=>{
  prizeType="SUPER";
  $("typeSuper").classList.add("active");
  $("typeNormal").classList.remove("active");
  renderPointsOptions(prizeType);
};

  // Random code generator
  function genCode(len=6){
    const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let out="";
    for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
    return out;
  }
  async function generateUniqueCode(){
    for(let i=0;i<20;i++){
      const c = genCode(6);
      const snap = await get(ref(db, `promo_codes/${c}`));
      if(!snap.exists()) return c;
    }
    // fallback
    return genCode(8);
  }

  // Generate button
  $("btnGenerate").onclick = async ()=>{
    const customer = $("customer").value.trim();
    const points = Number($("points").value);
    const expHours = Math.max(1, Number($("expHours").value || 24));
    const usageLimit = Math.max(1, Number($("usageLimit").value || 1));

    const code = await generateUniqueCode();
    const now = Date.now();
    const expiresAt = now + expHours*3600*1000;

    const payload = {
      code,
      customer: customer || "",
      points,
      prizeType,
      usageLimit,
      usedCount: 0,
      createdAt: now,
      expiresAt,
      status: "ACTIVE"
    };

    await set(ref(db, `promo_codes/${code}`), payload);

    $("genCode").textContent = code;
    $("genMeta").textContent = `${prizeType} ‚Ä¢ FREE ${points} ‚Ä¢ limit ${usageLimit} ‚Ä¢ expires in ${expHours}h`;
    $("btnCopy").disabled = false;
    $("btnCopy").dataset.code = code;
    toast("Code generated!");
  };

  $("btnCopy").onclick = async ()=>{
    const code = $("btnCopy").dataset.code;
    if(!code) return;
    await navigator.clipboard.writeText(code);
    toast("Copied!");
  };

  $("btnOpenUser").onclick = ()=>{
    // open user page same folder
    window.open("user.html","_blank");
  };

  // ===== Load Active Codes =====
  let allCodes = [];
  function statusTag(obj){
    const now = Date.now();
    const expired = now >= obj.expiresAt;
    const full = obj.usedCount >= obj.usageLimit;
    if(expired) return `<span class="tag bad">EXPIRED</span>`;
    if(full) return `<span class="tag warn">FULL</span>`;
    return `<span class="tag ok">ACTIVE</span>`;
  }

  function fmtTime(ts){
    const d = new Date(ts);
    return d.toLocaleString();
  }

  function renderCodes(list){
    const q = $("searchCode").value.trim().toUpperCase();
    const filtered = !q ? list : list.filter(x=>{
      return (x.code||"").includes(q) || (x.customer||"").toUpperCase().includes(q);
    });

    const tb = $("codesTbody");
    if(!filtered.length){
      tb.innerHTML = `<tr><td colspan="8" style="color:rgba(233,236,255,.65)">No promo codes found.</td></tr>`;
      return;
    }

    tb.innerHTML = filtered
      .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0))
      .slice(0,200)
      .map(x=>`
        <tr>
          <td style="font-weight:900;letter-spacing:1px">${x.code}</td>
          <td>${x.customer||"-"}</td>
          <td>FREE ${x.points}</td>
          <td>${x.prizeType||"-"}</td>
          <td>${x.usedCount||0}</td>
          <td>${x.usageLimit||1}</td>
          <td>${fmtTime(x.expiresAt)}</td>
          <td>${statusTag(x)}</td>
        </tr>
      `).join("");
  }

function loadCodesLive(){
  onValue(ref(db, "promo_codes"), (snap)=>{
    const v = snap.val() || {};
    allCodes = Object.keys(v).map(k=>v[k]);

    // ‚úÖ build map: CODE -> customer
    codeCustomerMap = {};
    for(const c of allCodes){
      if(c?.code) codeCustomerMap[String(c.code).toUpperCase()] = (c.customer || "");
    }

    renderCodes(allCodes);

    // ‚úÖ refresh history view (supaya nama terus muncul bila promo_codes loaded)
    if (allHist?.length) renderHist(allHist);
  });
}
  loadCodesLive();

  $("searchCode").addEventListener("input", ()=>renderCodes(allCodes));
  $("btnRefresh").onclick = async ()=>{
    const snap = await get(ref(db, "promo_codes"));
    const v = snap.val() || {};
    allCodes = Object.keys(v).map(k=>v[k]);
    renderCodes(allCodes);
    toast("Refreshed!");
  };

  // ===== Load History (latest) =====
  let allHist = [];
  let codeCustomerMap = {};
async function deleteHistRow(x){
  const ok = confirm(`Delete history for code ${x.code || x._code}?`);
  if(!ok) return;

  try{
    // delete only the history row
    await remove(ref(db, `redemptionsByCode/${x._code}/${x._rid}`));
    toast("Deleted!");
  }catch(e){
    alert("Delete failed: " + (e.message || e));
  }
}

function renderHist(list){
  const q = $("searchHist").value.trim().toUpperCase();
  const filtered = !q ? list : list.filter(x=>{
    return (String(x.code||"").toUpperCase().includes(q)) ||
           (String(x.userId||"").toUpperCase().includes(q));
  });

  const tb = $("histTbody");
  if(!filtered.length){
    tb.innerHTML = `<tr><td colspan="5" style="color:rgba(233,236,255,.65)">No history found.</td></tr>`;
    return;
  }

  const rows = filtered
    .sort((a,b)=> (b.redeemedAt||0)-(a.redeemedAt||0))
    .slice(0, 500);

  tb.innerHTML = rows.map(x=>`
    <tr>
      <td style="font-weight:900;letter-spacing:1px">${x.code || x._code}</td>
      <td>FREE ${x.points}</td>
      <td>${(codeCustomerMap[String(x.code || x._code || "").toUpperCase()] || x.customer || x.userId || "-")}</td>
      <td>${fmtTime(x.redeemedAt)}</td>
      <td style="text-align:right;">
        <button class="btnDel" data-del="${x._code}__${x._rid}">Delete</button>
      </td>
    </tr>
  `).join("");

  // attach delete events
  tb.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const key = btn.getAttribute("data-del");
      const [c, r] = key.split("__");
      const found = rows.find(x => x._code === c && x._rid === r);
      if(found) deleteHistRow(found);
    };
  });
}

function loadHistoryLive(){
  onValue(ref(db, "redemptionsByCode"), (snap)=>{
    const v = snap.val() || {};
    const arr = [];

    for(const code of Object.keys(v)){
      const group = v[code] || {};
      for(const rid of Object.keys(group)){
        const item = group[rid] || {};
        arr.push({
          ...item,
          _code: code,   // untuk delete path
          _rid: rid      // untuk delete path
        });
      }
    }

    allHist = arr;
    renderHist(allHist);
  });
}
  loadHistoryLive();
  $("searchHist").addEventListener("input", ()=>renderHist(allHist));
  $("btnClearView").onclick = ()=>{
    $("searchHist").value="";
    renderHist(allHist);
  };
  // ===== Sidebar UI =====
function openSidebar(){
  $("sideOverlay").style.display = "block";
  $("sidebar").classList.add("show");
}
function closeSidebar(){
  $("sideOverlay").style.display = "none";
  $("sidebar").classList.remove("show");
}
$("btnMenu").onclick = openSidebar;
$("btnSideClose").onclick = closeSidebar;
$("sideOverlay").onclick = closeSidebar;

// ===== Prize Modal UI =====
let editingType = "NORMAL";

function renderPrizePills(){
  const arr = (prizeConfig[editingType] || []).slice().sort((a,b)=>a-b);
  $("prizePills").innerHTML = arr.map(v=>`
    <div class="pillTag">
      FREE ${v}
      <button data-del="${v}" title="Remove">‚úï</button>
    </div>
  `).join("");

  $("prizePills").querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const val = parseInt(btn.getAttribute("data-del"),10);
      prizeConfig[editingType] = (prizeConfig[editingType]||[]).filter(x=>x!==val);
      renderPrizePills();
    };
  });
}

function openPrizeModal(){
  $("prizeOverlay").style.display = "grid";
  editingType = "NORMAL";
  $("tabNormal").classList.add("active");
  $("tabSuper").classList.remove("active");
  renderPrizePills();
}
function closePrizeModal(){
  $("prizeOverlay").style.display = "none";
}

$("sidePrize").onclick = async ()=>{
  closeSidebar();
  await loadPrizeConfig();
  openPrizeModal();
};

$("tabNormal").onclick = ()=>{
  editingType = "NORMAL";
  $("tabNormal").classList.add("active");
  $("tabSuper").classList.remove("active");
  renderPrizePills();
};
$("tabSuper").onclick = ()=>{
  editingType = "SUPER";
  $("tabSuper").classList.add("active");
  $("tabNormal").classList.remove("active");
  renderPrizePills();
};

$("prizeX").onclick = closePrizeModal;
$("prizeCancel").onclick = closePrizeModal;
$("prizeOverlay").addEventListener("click",(e)=>{
  if(e.target === $("prizeOverlay")) closePrizeModal();
});

$("prizeAdd").onclick = ()=>{
  const val = parseInt(($("prizeInput").value||"").trim(),10);
  if(!Number.isFinite(val) || val<=0) return toast("Enter valid number (e.g. 100)");
  const arr = prizeConfig[editingType] || [];
  if(arr.includes(val)) return toast("Prize already exists");
  arr.push(val);
  prizeConfig[editingType] = arr.sort((a,b)=>a-b);
  $("prizeInput").value = "";
  renderPrizePills();
};

$("prizeSave").onclick = async ()=>{
  prizeConfig = {
    NORMAL: cleanPrizeList(prizeConfig.NORMAL),
    SUPER:  cleanPrizeList(prizeConfig.SUPER)
  };

  await set(PRIZES_REF, prizeConfig);

  // refresh dropdown ikut tab yang dipilih
  renderPointsOptions(prizeType);

  closePrizeModal();
  toast("Prize settings saved!");
};
</script>
</body>
</html>
