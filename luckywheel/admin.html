<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Lucky Draw Admin</title>
<style>
  :root{
    --bg1:#120a2a; --bg2:#1a2c6b;
    --card:rgba(255,255,255,.08);
    --stroke:rgba(255,255,255,.12);
    --gold1:#1668dc; --gold2:#ff8a00;
    --txt:#e9ecff; --muted:rgba(233,236,255,.7);
    --ok:#27d17f; --bad:#ff4d4d;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    color:var(--txt);
    background:#000;
    min-height:100vh;
  }
  header{
    height:64px; display:flex; align-items:center; justify-content:space-between;
    padding:0 18px;
    background:linear-gradient(90deg, rgba(0,0,0,.45), rgba(0,0,0,.15));
    border-bottom:1px solid var(--stroke);
    backdrop-filter: blur(10px);
  }
  .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.5px}
  .dot{width:12px; height:12px; border-radius:999px; background:linear-gradient(90deg,var(--gold1),var(--gold2)); box-shadow:0 0 18px rgba(255,170,0,.55)}
  nav a{color:var(--muted); text-decoration:none; margin-left:14px; font-weight:600}
  nav a:hover{color:var(--txt)}
  .wrap{max-width:1150px; margin:22px auto; padding:0 16px}
  .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px}
  .card{
    background:var(--card); border:1px solid var(--stroke); border-radius:16px;
    box-shadow: 0 18px 50px rgba(0,0,0,.35);
    backdrop-filter: blur(12px);
    overflow:hidden;
  }
  .card h3{margin:0; padding:14px 16px; border-bottom:1px solid var(--stroke); display:flex; align-items:center; gap:10px}
  .card .body{padding:16px}
  label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
  input, select{
    width:100%; padding:12px 12px; border-radius:12px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(0,0,0,.22);
    color:var(--txt); outline:none;
    transition: all 0.2s;
  }
  input:hover, select:hover{border-color:#3c89e8;}
  input:focus, select:focus{border-color:#1668dc;}
  .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px}
  .toggle{
    display:flex; gap:10px; margin-top:10px;
  }
  .pill{
    flex:1; padding:11px 12px; border-radius:12px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(0,0,0,.18);
    color:var(--muted); font-weight:800; cursor:pointer;
    display:flex; align-items:center; justify-content:center; gap:8px;
    transition: all 0.2s;
  }
  .pill.active{
    background:rgba(40,110,255,.22);
    border-color:#1668dc;
    color:var(--txt);
  }
  .btn{
    width:100%; margin-top:14px;
    padding:12px 14px; border-radius:12px; border:none;cursor:pointer; color:#fff;
    background:#1668dc;
    box-shadow:0 10px 24px rgba(0,0,0,.25);
    transition: all 0.2s;
  }
  .btn:active{transform:translateY(1px)}
  .codeBox{
    border-radius:14px; padding:14px; border:1px solid var(--stroke);
    background:rgba(0,0,0,.18);text-align: center;
  }
  .bigCode{font-size:25px;letter-spacing:2px; margin:4px 0 2px}
  .sub{color:var(--muted); font-size:12px}
  .btn2{
    margin-top:10px; width:100%;
    padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.16);
    background:rgba(0,0,0,.18); color:var(--txt); font-weight:800; cursor:pointer;
    transition: all 0.2s;
  }
  .btn2:hover{border-color:#3c89e8;}
  .btn2:active{border-color:#1554ad;}
  .tableWrap{
  overflow: hidden;   
  border-radius: 14px;
}
  /* ===== ACTIVE CODES: scroll KANAN SAHAJA ===== */
/* ===== ACTIVE CODES: 15 ROW + SCROLL (Y & X) ===== */
#codes .tableWrap{
  max-height: calc(15 * 48px);   /* 15 baris */
  overflow: auto;               /* boleh scroll bawah + kanan */
  -webkit-overflow-scrolling: touch;
}
#codes .tableWrap table{
  min-width: 1100px;
  width: 100%;
}

/* scrollbar horizontal nipis & cantik */
#codes .tableWrap::-webkit-scrollbar{
  height: 6px;
}
#codes .tableWrap::-webkit-scrollbar-track{
  background: rgba(255,255,255,.06);
  border-radius: 999px;
}
#codes .tableWrap::-webkit-scrollbar-thumb{
  background: linear-gradient(90deg, #ffcc55, #ff8a00);
  border-radius: 999px;
}
#codes .tableWrap::-webkit-scrollbar-thumb:hover{
  background: linear-gradient(90deg, #ffd97a, #ff9d20);
}

/* firefox */
#codes .tableWrap{
  scrollbar-width: thin;
  scrollbar-color: #1668dc rgba(255,255,255,.06);
}
  table{width:100%; border-collapse:collapse; font-size:13px}
  th,td{padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.10); text-align:center; white-space:nowrap}
  th{color:var(--muted); font-weight:800}
  .tag{
    display:inline-flex; align-items:center; gap:6px;
    padding:4px 10px; border-radius:999px; font-size:12px; font-weight:900;
    border:1px solid rgba(255,255,255,.14); background:rgba(0,0,0,.2)
  }
  .tag.ok{border-color:rgba(39,209,127,.35); color:#bff7dc}
  .tag.bad{border-color:rgba(255,77,77,.35); color:#ffd0d0}
  .tag.warn{border-color:rgba(255,200,85,.35); color:#ffe7b5}
  .mini{
    display:flex; gap:10px; align-items:center; justify-content:space-between;
    margin-top:10px;
  }
  .toast{
    position:fixed; right:16px; bottom:16px;
    background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.14);
    backdrop-filter:blur(10px);
    padding:10px 12px; border-radius:12px; color:var(--txt);
    display:none; max-width:360px;
    transition: all 0.2s;
  }
  .headLeft{display:flex;align-items:center;gap:12px}
.menuBtn{
  width:44px;height:44px;border-radius:14px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.18);
  color:#fff;font-size:20px;cursor:pointer;
  transition: all 0.2s;
}
.menuBtn:hover{filter:brightness(1.1)}

.sideOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,.45);
  display:none;z-index:80;
}
.sidebar{
  position:fixed;top:0;left:0;height:100vh;width:320px;
  transform:translateX(-110%);
  transition:transform .25s ease;
  background:rgba(12,16,40,.92);
  border-right:1px solid rgba(255,255,255,.12);
  backdrop-filter:blur(14px);
  z-index:90;
  padding:14px;
  transition: all 0.2s;
}
.sidebar.show{transform:translateX(0)}
.sideHead{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.sideTitle{font-size:16px;font-weight:900}
.sideClose{
  width:38px;height:38px;border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);color:#fff;cursor:pointer
}
.sideItem{
  width:100%;padding:12px 12px;border-radius:14px;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(255,255,255,.06);
  color:#fff;font-weight:800;cursor:pointer;
  text-align:left;margin-top:10px;
}

/* Prize Modal */
.modalOverlay{
  position:fixed;inset:0;display:none;place-items:center;
  background:rgba(0,0,0,.55);z-index:100;
}
.modalCard{
  width:min(520px,92vw);
  background:rgba(18,22,56,.92);
  border:1px solid rgba(255,255,255,.14);
  border-radius:18px;
  box-shadow:0 20px 60px rgba(0,0,0,.45);
  backdrop-filter:blur(14px);
  overflow:hidden;
  transition: all 0.2s;
}
.modalHead{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.10);
}
.modalTitle{font-weight:900}
.modalX{
  width:36px;height:36px;border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(255,255,255,.06);
  color:#fff;cursor:pointer;
  transition: all 0.2s;
}
.modalBody{padding:14px 16px}
.modalFoot{
  padding:12px 16px;display:flex;justify-content:flex-end;gap:10px;
  border-top:1px solid rgba(255,255,255,.10);
}
.tabsRow{display:flex;gap:10px;margin-bottom:10px}
.tabBtn{
  flex:1;padding:10px;border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  color:#fff;font-weight:900;cursor:pointer;
}
.tabBtn.active{
  background:linear-gradient(90deg, rgba(255,210,102,.35), rgba(255,120,72,.25));
  border-color:rgba(255,210,102,.35);
}
.pillRow{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0}
.pillTag{
  display:flex;align-items:center;gap:8px;
  padding:5px 10px;border-radius:8px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.10);
  color:#fff;
}
.pillTag button{
  width:26px;height:26px;border-radius:999px;
  border:1px solid rgba(255,255,255,.14);
  background:rgba(0,0,0,.20);
  color:#fff;cursor:pointer;font-weight:900;
}
.addRow{
  display:grid;
  grid-template-columns: 1fr auto;  /* input = full, button ikut size */
  gap:10px;
  margin-top:10px;
  width:100%;
  transition: all 0.2s;
}

.addRow input{
  width:100%;           /* pastikan penuh */
  padding:12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(0,0,0,.18);
  color:#fff;
  outline:none;
  transition: all 0.2s;
}

#prizeAdd{               /* buat button kemas */
  min-width: 90px;
  white-space:nowrap;
}
/* ===== HISTORY: max 15 rows, scroll ===== */
#history .tableWrap{
  max-height: calc(15 * 46px); /* 15 row, adjust kalau row tinggi */
  overflow: auto;
  border-radius: 14px;
}

/* sticky header bila scroll */
#history .tableWrap thead th{
  position: sticky;
  top: 0;
  z-index: 2;
  background: linear-gradient(90deg, rgba(30,40,110,.95), rgba(25,35,95,.95));
  backdrop-filter: blur(10px);
}

/* cantikkan scrollbar */
#history .tableWrap::-webkit-scrollbar{ width: 10px; height:10px; }
#history .tableWrap::-webkit-scrollbar-track{
  background: rgba(255,255,255,.06);
  border-radius: 999px;
}
#history .tableWrap::-webkit-scrollbar-thumb{
  background: linear-gradient(180deg, rgba(255,77,216,.75), rgba(106,64,255,.75));
  border-radius: 999px;
  border: 2px solid rgba(0,0,0,.25);
}
#history .tableWrap{ scrollbar-width: thin; scrollbar-color: rgba(255,77,216,.75) rgba(255,255,255,.06); }

/* delete button */
.btnDel{
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,80,80,.12);
  color: rgba(255,210,210,.95);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}
.btnDel:hover{ background: rgba(255,80,80,.20); }
.btnDel:active{ transform: translateY(1px); }
.small-status {
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0; 
  text-transform: none;
}

#codesTbody tr {
  height: 48px;
}
#codes .tableWrap thead th{
  position: sticky;
  top: 0;
  z-index: 2;
  background: linear-gradient(90deg, rgba(30,40,110,.95), rgba(25,35,95,.95));
  backdrop-filter: blur(10px);
}

.niceInput{
  width:100%;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.18);
  color:var(--txt);
  font-weight:800;
  outline:none;
  transition: all 0.2s;
}
.niceInput:hover{border-color:rgba(255,200,85,.45)}
.niceInput:focus{
  border-color:rgba(255,200,85,.7);
  box-shadow:0 0 0 3px rgba(255,180,0,.15);
}
.niceInput::-webkit-calendar-picker-indicator{
  filter: invert(1) opacity(.75);
  cursor:pointer;
}

/* ===== SUMMARY CARDS ===== */
.summaryRow{
  margin-top:10px;
  display:grid;
  grid-template-columns: repeat(3, 1fr);
  gap:10px;
  text-align: center;
}
.sumCard{
  border-radius:14px;
  border:1px solid rgba(255,255,255,.12);
  background:rgba(255,255,255,.06);
  padding:10px 12px;
}
.sumLabel{font-size:12px;color:#fff;}
.sumValue{font-size:14px;letter-spacing:.5px;margin-top:2px}
@media (max-width:720px){
  .summaryRow{grid-template-columns:1fr}
}
.chipBtn{
  appearance:none;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(20,24,55,.55);
  color: rgba(233,236,255,.9);
  padding:8px 12px;
  border-radius:999px;
  font-weight:700;
  cursor:pointer;
  transition:.15s ease;
  transition: all 0.2s;
}
.chipBtn:hover{
  background: rgba(255,255,255,.08);
  border-color: rgba(255,255,255,.25);
}
.chipBtn.active{
  background: linear-gradient(135deg, rgba(255,204,85,.25), rgba(255,138,0,.18));
  border-color: rgba(255,204,85,.55);
  box-shadow: 0 0 0 2px rgba(255,204,85,.10) inset;
}
/* hide native select */
.nativeSelect{
  position:absolute !important;
  left:-9999px !important;
  width:1px !important;
  height:1px !important;
  opacity:0 !important;
  pointer-events:none !important;
}
.cs.open .csMenu{ display:block; }
.csItem:last-child{ border-bottom:none; }

.csItem:hover{
  background: linear-gradient(90deg, rgba(255,204,85,.22), rgba(255,138,0,.14));
}

.csItem.active{
  background: linear-gradient(90deg, rgba(40,110,255,.28), rgba(40,110,255,.14));
  outline: 1px solid rgba(40,110,255,.45);
}

.csItem.selected{
  background: linear-gradient(90deg, rgba(255,204,85,.26), rgba(255,138,0,.16));
}

/* scrollbar cantik */
.csMenu::-webkit-scrollbar{ width:10px; }
.csMenu::-webkit-scrollbar-track{ background: rgba(255,255,255,.06); }
.csMenu::-webkit-scrollbar-thumb{
  background: linear-gradient(180deg, #ffcc55, #ff8a00);
  border-radius: 999px;
}
.csMenu{ scrollbar-width: thin; scrollbar-color:#1668dc rgba(255,255,255,.06); }
/* ===== COMPACT CUSTOM SELECT (MATCH NATIVE SIZE) ===== */
.cs{ position:relative; width:100%; }

.csBtn{
  width:100%;
  height:44px;              
  padding:0 42px 0 12px;       
  border-radius:12px;     
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.22);
  color:var(--txt);
  font-weight:800;
  font-size:14px;
  line-height:44px;
  cursor:pointer;
  user-select:none;
  display:block;
  text-align:left;
  position:relative;
  transition: all 0.2s;
}

.csBtn:hover{ border-color:#3c89e8; }
.csBtn:focus{
  outline:none;
  border-color: #1668dc;
  box-shadow: #286eff8c;
}

/* Arrow button kecil di kanan */
.csArrow{
  position:absolute;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  display:grid;
  place-items:center;
  font-size:12px;
  opacity:.9;
}
.cs.open .csArrow{ transform:translateY(-50%) rotate(180deg); }

/* label jangan besar */
.csLabel{
  display:block;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* dropdown list compact */
.csMenu{
  position:absolute;
  left:0; right:0;
  top: calc(100% + 6px);
  z-index:9999;
  border-radius:12px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(10,12,28,.92);
  backdrop-filter: blur(12px);
  box-shadow: 0 14px 40px rgba(0,0,0,.45);
  overflow:hidden;

  max-height: 180px;           /* ‚úÖ kecil */
  overflow:auto;
  transition: all 0.2s;
  display:none;
}
.cs.open .csMenu{ display:block; }

.csItem{
  padding:10px 12px;           /* ‚úÖ kecil */
  font-size:13px;
  font-weight:800;
  color: rgba(233,236,255,.92);
  cursor:pointer;
  border-bottom:1px solid rgba(255,255,255,.08);
  background:transparent;
  transition: all 0.2s;
}
.csItem:last-child{ border-bottom:none; }

.csItem:hover{
  background: rgba(40,110,255,.18);   /* hover macam native */
}

.csItem.selected{
  background: rgba(255,204,85,.14);   /* selected */
}

.csItem.active{
  background: rgba(40,110,255,.28);   /* active highlight */
  outline: 1px solid rgba(40,110,255,.35);
}

/* scrollbar kecil */
.csMenu::-webkit-scrollbar{ width:8px; }
.csMenu::-webkit-scrollbar-track{ background: rgba(255,255,255,.06); }
.csMenu::-webkit-scrollbar-thumb{
  background: linear-gradient(180deg, #ffcc55, #ff8a00);
  border-radius:999px;
}
/* FIX: selectWrap jangan shrink */
.selectWrap{
  width:100% !important;
  display:flex !important;        /* dari inline-flex ‚Üí flex */
  align-items:center;
}

/* custom mount full width dalam selectWrap */
.selectWrap > #prizeFilterCS{
  flex:1 1 auto !important;
  width:100% !important;
  min-width:0 !important;
}

/* pastikan cs full */
#prizeFilterCS .cs,
#prizeFilterCS .csBtn{
  width:100% !important;
}
/* === Prize add row: input & button sama tinggi === */
.addRow input,
#prizeAdd{
  height:44px;
  padding:0 14px;
  line-height:44px;
}

/* buang margin-top khas btn2 dalam row add */
#prizeAdd{ margin-top:0 !important; }

/* === Modal footer: Cancel & Save sama tinggi === */
.modalFoot .btn2,
.modalFoot .btn{
  height:44px;
  padding:0 16px;
  line-height:44px;
  display:flex;
  align-items:center;
  justify-content:center;
  margin-top:0; /* penting untuk btn */
}
  
input::-webkit-inner-spin-button,
input::-webkit-outer-spin-button {
  -webkit-appearance: none !important;
  margin: 0;
}

/* Firefox */
input[type="number"]{
  -moz-appearance: textfield !important;
  appearance: textfield !important;
}
</style>
</head>
<body>
<header>
  <div class="headLeft">
    <button id="btnMenu" class="menuBtn">‚ò∞</button>
    <div class="brand"><span class="dot"></span> LUCKY DRAW <span style="opacity:.6;font-weight:700">ADMIN</span></div>
  </div>

  <nav>
    <a href="user.html">Home</a>
    <a href="#codes">Codes</a>
    <a href="#history">History</a>
  </nav>
</header>

<!-- Sidebar overlay -->
<div id="sideOverlay" class="sideOverlay"></div>

<!-- Sidebar -->
<aside id="sidebar" class="sidebar">
  <div class="sideHead">
    <div class="sideTitle">Menu</div>
    <button id="btnSideClose" class="sideClose">‚úï</button>
  </div>

  <button class="sideItem" id="sidePrize">üèÜ Prize Settings</button>
</aside>

<!-- Prize Modal -->
<div id="prizeOverlay" class="modalOverlay">
  <div class="modalCard">
    <div class="modalHead">
      <div class="modalTitle">Prize Settings</div>
      <button id="prizeX" class="modalX">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="tabsRow">
        <button id="tabNormal" class="tabBtn active">NORMAL</button>
        <button id="tabSuper" class="tabBtn">SUPER</button>
      </div>

      <div class="pillRow" id="prizePills"></div>

      <div class="addRow">
        <input id="prizeInput" type="number" placeholder="Add prize (e.g. 100)" />
        <button id="prizeAdd" class="btn2">+ Add</button>
      </div>

      <small style="opacity:.75;display:block;margin-top:10px;">
        Tambah/remove prize di sini. Tekan Save untuk simpan ke Firebase.
      </small>
    </div>

    <div class="modalFoot">
      <button id="prizeCancel" class="btn2">Cancel</button>
      <button id="prizeSave" class="btn">Save</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="grid">
    <div class="card">
      <h3>üéüÔ∏è Generate Promo Code</h3>
      <div class="body">
        <label>Username Customer</label>
        <input id="customer"/>

        <div class="toggle">
          <button class="pill active" id="typeNormal">üéØ NORMAL PRIZE</button>
          <button class="pill" id="typeSuper">‚≠ê SUPER PRIZE</button>
        </div>

<label>Select Prize (Points)</label>
<select id="points" class="nativeSelect"></select>
<div class="cs" id="pointsCS"></div>

        <div class="row">
          <div>
            <label>Expiration Time (hours)</label>
            <input id="expHours" type="number" min="1" value="24"/>
          </div>
          <div>
            <label>Usage Limit</label>
            <input id="usageLimit" type="number" min="1" value="1"/>
          </div>
        </div>

        <button class="btn" id="btnGenerate">Ôºã Generate Promo Code</button>
      </div>
    </div>

    <div class="card">
      <h3>‚úÖ Generated Code</h3>
      <div class="body">
        <div class="codeBox">
          <div class="sub">Your code</div>
          <div class="bigCode" id="genCode">‚Äî ‚Äî ‚Äî ‚Äî ‚Äî ‚Äî</div>
          <div class="sub" id="genMeta">Generate a code to see details.</div>
          <button class="btn2" id="btnCopy" disabled>üìã Copy Code</button>
        </div>
      </div>
      <!-- ===== FILTER + SUMMARY (UNDER CODEBOX) ===== -->
<div class="codeTools" style="padding:14px;">
  <div class="selectWrap">
<select id="prizeFilter" class="nativeSelect">
  <option value="ALL">All Prize</option>
  <option value="NORMAL">Normal Prize</option>
  <option value="SUPER">Super Prize</option>
</select>

<div id="prizeFilterCS"></div>
  </div>

  <div class="summaryRow">
    <div class="sumCard">
      <div class="sumLabel">Total Customer</div>
      <div class="sumValue" id="sumCustomers">0</div>
    </div>
    <div class="sumCard">
      <div class="sumLabel">Total Prize</div>
      <div class="sumValue" id="sumPrize">0</div>
    </div>
    <div class="sumCard">
      <div class="sumLabel">Total Code</div>
      <div class="sumValue" id="sumCodes">0</div>
    </div>
  </div>

  <div class="sub" id="sumHint" style="margin-top:8px;opacity:.75">
    Summary based on Active Promo Codes.
  </div>
</div>
    </div>
  </div>

  <div style="height:16px"></div>

  <div class="card" id="codes">
    <h3>üßæ Active Promo Codes</h3>
    <div class="body">
      <div class="row">
        <input id="searchCode" placeholder="Search by code / customer..."/>
        <button class="btn2" id="btnRefresh">‚Üª Refresh</button>
      </div>
<div class="tableWrap table-scroll" style="margin-top:10px">
  <table>
    <thead>
      <tr>
        <th>Code</th>
        <th>Customer</th>
        <th>Prize</th>
        <th>Type</th>
        <th>Used</th>
        <th>Limit</th>
        <th>Expires</th>
        <th>Created At</th>
        <th>Claimed At</th>
        <th>Status</th>
        <th style="width:120px;text-align:center;">Action</th>
      </tr>
    </thead>

    <tbody id="codesTbody">
      <tr><td colspan="11" style="color:rgba(233,236,255,.65)">Loading...</td></tr>
    </tbody>
  </table>
</div>
    </div>
  </div>
<div style="height:16px"></div>
<div class="card" id="totalsHistoryCard">
  <h3>üìä Totals History</h3>
  <div class="body">
<div class="mini" style="gap:12px;flex-wrap:wrap;align-items:center">

  <!-- kiri: date range -->
  <div class="dateRangeRow" style="display:flex;gap:10px;flex:1;min-width:320px">
    <input id="rangeFrom" class="niceInput" type="date">
    <input id="rangeTo" class="niceInput" type="date">
  </div>

  <!-- kanan: preset chips -->
  <div class="presetRow" id="presetRow" style="display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end">
    <button class="chipBtn active" data-preset="today">Today</button>
    <button class="chipBtn" data-preset="yesterday">Yesterday</button>
    <button class="chipBtn" data-preset="thisweek">This Week</button>
    <button class="chipBtn" data-preset="lastweek">Last Week</button>
    <button class="chipBtn" data-preset="thismonth">This Month</button>
    <button class="chipBtn" data-preset="lastmonth">Last Month</button>
  </div>

</div>

    <div class="tableWrap" style="margin-top:12px">
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Total Customer</th>
            <th>Total Prize</th>
            <th>Total Code</th>
            <th>Normal Codes</th>
            <th>Super Codes</th>
          </tr>
        </thead>
        <tbody id="statsTbody">
          <tr><td colspan="6" style="opacity:.7">No stats yet.</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
  <div style="height:16px"></div>

  <div class="card" id="history">
    <h3>üìú Redemption History</h3>
    <div class="body">
      <div class="row">
        <input id="searchHist" placeholder="Search by code / userId..."/>
        <button class="btn2" id="btnClearView">Clear Filter</button>
      </div>
      <div class="tableWrap" style="margin-top:10px">
        <table>
<thead>
  <tr>
    <th>Code</th>
    <th>Points</th>
    <th>User</th>
    <th>Redeemed At</th>
    <th style="width:110px;text-align:right;">Actions</th>
  </tr>
</thead>
<tbody id="histTbody">
  <tr><td colspan="5" style="color:rgba(233,236,255,.65)">No history yet.</td></tr>
</tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<!-- Firebase v9 (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getDatabase, ref, set, get, child, onValue, query, limitToLast,remove,update
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDSqpbnkb3GLNFlHLYSz5XyRYPvKLAOCOA",
  authDomain: "lucky-spined.firebaseapp.com",
  databaseURL: "https://lucky-spined-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "lucky-spined",
  storageBucket: "lucky-spined.firebasestorage.app",
  messagingSenderId: "708886212396",
  appId: "1:708886212396:web:2cb7a900fe1a7891510689"
};

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ===== UI helpers =====
  const $ = (id)=>document.getElementById(id);
  const toast = (msg)=>{
    $("toast").textContent = msg;
    $("toast").style.display="block";
    clearTimeout(window.__t);
    window.__t = setTimeout(()=> $("toast").style.display="none", 2200);
  };
let pointsCSApi = null;
let prizeFilterCSApi = null;
  
function buildCustomSelect(selectEl, mountEl){
  if(!selectEl || !mountEl) return;

  mountEl.innerHTML = "";

  const wrap = document.createElement("div");
  wrap.className = "cs";

  const btn = document.createElement("button");
  btn.type = "button";
  btn.className = "csBtn";
  btn.innerHTML = `
    <span class="csLabel">-- Select --</span>
    <span class="csArrow">‚ñæ</span>
  `;

  const menu = document.createElement("div");
  menu.className = "csMenu";

  wrap.appendChild(btn);
  wrap.appendChild(menu);
  mountEl.appendChild(wrap);

  const labelEl = btn.querySelector(".csLabel");

  function close(){ wrap.classList.remove("open"); }
  function open(){
    wrap.classList.add("open");
    const act = menu.querySelector(".csItem.active") || menu.querySelector(".csItem.selected");
    if(act) act.scrollIntoView({block:"nearest"});
  }
  function toggle(){ wrap.classList.contains("open") ? close() : open(); }

  function setLabelFromSelect(){
    const opt = selectEl.options[selectEl.selectedIndex];
    labelEl.textContent = opt ? opt.textContent : "-- Select --";
  }

  function syncActiveSelected(){
    const v = selectEl.value;
    menu.querySelectorAll(".csItem").forEach(it=>{
      it.classList.remove("active","selected");
      if(it.dataset.value === v) it.classList.add("active","selected");
    });
    setLabelFromSelect();
  }

  function rebuild(){
    menu.innerHTML = "";
    [...selectEl.options].forEach(opt=>{
      const item = document.createElement("div");
      item.className = "csItem";
      item.textContent = opt.textContent;
      item.dataset.value = opt.value;

      item.addEventListener("click", ()=>{
        selectEl.value = opt.value;
        selectEl.dispatchEvent(new Event("change", {bubbles:true}));
        close();
      });

      menu.appendChild(item);
    });

    setLabelFromSelect();
    syncActiveSelected();
  }

  btn.addEventListener("click", toggle);

  document.addEventListener("click", (e)=>{
    if(!wrap.contains(e.target)) close();
  });

  btn.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" || e.key === " "){ e.preventDefault(); toggle(); }
    if(e.key === "Escape"){ close(); }
  });

  selectEl.addEventListener("change", syncActiveSelected);

  rebuild();

  return { rebuild, close, open };
}

function initPointsCustomSelect(){
  const sel = $("points");
  const mount = document.getElementById("pointsCS");
  if(!sel || !mount) return;
  pointsCSApi = buildCustomSelect(sel, mount);
}

function refreshPointsCustomSelect(){
  if(pointsCSApi && pointsCSApi.rebuild) pointsCSApi.rebuild();
}
function initPrizeFilterCustomSelect(){
  const sel = $("prizeFilter");
  const mount = document.getElementById("prizeFilterCS");
  if(!sel || !mount) return;
  prizeFilterCSApi = buildCustomSelect(sel, mount);
}
function refreshPrizeFilterCustomSelect(){
  if(prizeFilterCSApi && prizeFilterCSApi.rebuild) prizeFilterCSApi.rebuild();
}
function cleanPrizeList(arr){
  return (arr || [])
    .map(v => Number(v))
    .filter(v => Number.isFinite(v) && v > 0)
    .filter((v,i,a) => a.indexOf(v) === i)
    .sort((a,b)=>a-b);
}
// ===== Prize settings in Firebase =====
const PRIZES_REF = ref(db, "settings/prizes");

// default kalau Firebase kosong
let prizeConfig = {
  NORMAL: [3, 6, 9, 12, 15, 18],
  SUPER:  [20, 25, 30, 35, 40, 88]
};

async function loadPrizeConfig(){
  const snap = await get(PRIZES_REF);

  if(snap.exists()){
    const v = snap.val() || {};
    prizeConfig = {
      NORMAL: cleanPrizeList(v.NORMAL ?? prizeConfig.NORMAL),
      SUPER:  cleanPrizeList(v.SUPER  ?? prizeConfig.SUPER)
    };
  }else{
    // pastikan default pun bersih sebelum simpan
    prizeConfig = {
      NORMAL: cleanPrizeList(prizeConfig.NORMAL),
      SUPER:  cleanPrizeList(prizeConfig.SUPER)
    };
    await set(PRIZES_REF, prizeConfig);
  }
}

// Render dropdown points ikut prizeConfig
function renderPointsOptions(type){
  const list = (prizeConfig[type] || []).slice().sort((a,b)=>a-b);
  const sel = $("points");
  sel.innerHTML = list.map(p => `<option value="${p}">FREE ${p}</option>`).join("");
  if(list.length) sel.value = String(list[0]);
  refreshPointsCustomSelect();
}

// Prize type toggle
let prizeType = "NORMAL";

await loadPrizeConfig();
renderPointsOptions(prizeType);
initPointsCustomSelect();
refreshPointsCustomSelect();

$("typeNormal").onclick = ()=>{
  prizeType="NORMAL";
  $("typeNormal").classList.add("active");
  $("typeSuper").classList.remove("active");
  renderPointsOptions(prizeType);
};

$("typeSuper").onclick = ()=>{
  prizeType="SUPER";
  $("typeSuper").classList.add("active");
  $("typeNormal").classList.remove("active");
  renderPointsOptions(prizeType);
};

  // Random code generator
  function genCode(len=6){
    const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
    let out="";
    for(let i=0;i<len;i++) out += chars[Math.floor(Math.random()*chars.length)];
    return out;
  }
  async function generateUniqueCode(){
    for(let i=0;i<20;i++){
      const c = genCode(6);
      const snap = await get(ref(db, `promo_codes/${c}`));
      if(!snap.exists()) return c;
    }
    // fallback
    return genCode(8);
  }

  // Generate button
  $("btnGenerate").onclick = async ()=>{
    const customer = $("customer").value.trim();
    if(!customer){
    toast("Please enter Customer Name/ID first!");
    $("customer").focus();
    return;
  }
    const points = Number($("points").value);
    const expHours = Math.max(1, Number($("expHours").value || 24));
    const usageLimit = Math.max(1, Number($("usageLimit").value || 1));

    const code = await generateUniqueCode();
    const now = Date.now();
    const expiresAt = now + expHours*3600*1000;

const payload = {
  code,
  customer: customer || "",
  points,
  prizeType,
  usageLimit,
  usedCount: 0,
  createdAt: now,
  expiresAt,
  claimedAt: null,        
  claimStatus: "Pending",
  status: "ACTIVE"
};

    await set(ref(db, `promo_codes/${code}`), payload);

    $("genCode").textContent = code;
    $("genMeta").textContent = `${prizeType} ‚Ä¢ FREE ${points} ‚Ä¢ limit ${usageLimit} ‚Ä¢ expires in ${expHours}h`;
    $("btnCopy").disabled = false;
    $("btnCopy").dataset.code = code;
    toast("Code generated!");
  };

  $("btnCopy").onclick = async ()=>{
    const code = $("btnCopy").dataset.code;
    if(!code) return;
    await navigator.clipboard.writeText(code);
    toast("Copied!");
  };
;
  // ===== Load Active Codes =====
  let allCodes = [];
  let codeCustomerMap = {};
  function statusTag(obj){
    const now = Date.now();
    const expired = now >= obj.expiresAt;
    const full = obj.usedCount >= obj.usageLimit;
    if(expired) return `<span class="tag bad">EXPIRED</span>`;
    if(full) return `<span class="tag warn">FULL</span>`;
    return `<span class="tag ok">ACTIVE</span>`;
  }

  function fmtTime(ts){
    const d = new Date(ts);
    return d.toLocaleString();
  }

async function deletePromoCode(code){
  const ok = confirm(`Delete promo code: ${code}?`);
  if(!ok) return;

  try{
    await remove(ref(db, `promo_codes/${code}`));
    toast("Promo code deleted!");
  }catch(e){
    alert("Delete failed: " + (e.message || e));
  }
}

function renderCodes(list){
  const q = $("searchCode").value.trim().toUpperCase();
  const filtered = !q ? list : list.filter(x=>{
    return String(x.code||"").toUpperCase().includes(q) ||
           String(x.customer||"").toUpperCase().includes(q);
  });

  const tb = $("codesTbody");
  if(!filtered.length){
    tb.innerHTML = `<tr><td colspan="11" style="color:rgba(233,236,255,.65)">No promo codes found.</td></tr>`;
    return;
  }

  const rows = filtered
    .sort((a,b)=> (b.createdAt||0)-(a.createdAt||0))
    .slice(0,200);

  const statusBadge = (x)=>{
    if (x.claimedAt || (Number(x.usedCount||0) > 0)) {
      return `<span class="tag ok small-status">Approved</span>`;
    }
    return `<span class="tag warn small-status">Pending</span>`;
  };

  tb.innerHTML = rows.map(x=>`
    <tr>
      <td style="font-weight:900;letter-spacing:1px">${x.code}</td>
      <td>${x.customer||"-"}</td>
      <td>FREE ${x.points}</td>
      <td>${x.prizeType||"-"}</td>
      <td>${x.usedCount||0}</td>
      <td>${x.usageLimit||1}</td>
      <td>${fmtTime(x.expiresAt)}</td>
      <td>${x.createdAt ? fmtTime(x.createdAt) : "-"}</td>
      <td>${x.claimedAt ? fmtTime(x.claimedAt) : "-"}</td>
      <td>${statusBadge(x)}</td>
      <td style="text-align:right;">
        <button class="btnDel" data-delcode="${x.code}">Delete</button>
      </td>
    </tr>
  `).join("");

  // attach delete events
  tb.querySelectorAll("[data-delcode]").forEach(btn=>{
    btn.onclick = ()=>{
      const code = btn.getAttribute("data-delcode");
      deletePromoCode(code);
    };
  });
}
function loadCodesLive(){
  onValue(
    ref(db, "promo_codes"),
    (snap)=>{
      console.log("promo_codes exists?", snap.exists());
      const v = snap.val() || {};
      allCodes = Object.keys(v).map(k=>v[k]);

      codeCustomerMap = {};
      for(const c of allCodes){
        if(c?.code) codeCustomerMap[String(c.code).toUpperCase()] = (c.customer || "");
      }

renderCodes(allCodes);
updateSummaryUI();
refreshTotalsHistoryLive();

if (allHist?.length) renderHist(allHist);;
    },
    (err)=>{
      console.error("promo_codes onValue ERROR:", err);
      toast("Load codes failed: " + (err?.code || err?.message || err));
    }
  );
}
loadCodesLive();

  $("searchCode").addEventListener("input", ()=>renderCodes(allCodes));
  $("btnRefresh").onclick = async ()=>{
    const snap = await get(ref(db, "promo_codes"));
    const v = snap.val() || {};
    allCodes = Object.keys(v).map(k=>v[k]);
    renderCodes(allCodes);
    toast("Refreshed!");
  };

  // ===== Load History (latest) =====
  let allHist = [];
async function deleteHistRow(x){
  const ok = confirm(`Delete history for code ${x._code}?`);
  if(!ok) return;

  try{
    const updates = {};

    // 1) delete group utama
    updates[`redemptionsByCode/${x._code}/${x._rid}`] = null;

    // 2) cuba delete redemptionsAll by same key (untuk data baru)
    updates[`redemptionsAll/${x._rid}`] = null;

    // 3) optional userHistory
    if(x.userId){
      updates[`userHistory/${x.userId}/${x._rid}`] = null;
    }

    // ====== fallback untuk DATA LAMA (redemptionsAll key random) ======
    const allSnap = await get(ref(db, "redemptionsAll"));
    if(allSnap.exists()){
      const all = allSnap.val() || {};
      const targetCode = String(x._code || x.code || "").toUpperCase();
      const targetAt   = Number(x.redeemedAt || 0);

      for(const k of Object.keys(all)){
        const it = all[k] || {};
        const itCode = String(it.code || "").toUpperCase();
        const itAt   = Number(it.redeemedAt || 0);

        // match paling selamat: code + redeemedAt
        if(itCode === targetCode && itAt === targetAt){
          updates[`redemptionsAll/${k}`] = null;
          break;
        }
      }
    }

    await update(ref(db), updates);
    toast("Deleted (admin + user)!");
  }catch(e){
    alert("Delete failed: " + (e.message || e));
  }
}
function renderHist(list){
  const q = $("searchHist").value.trim().toUpperCase();
 const filtered = !q ? list : list.filter(x=>{
    const code = String(x.code || x._code || "").toUpperCase();
    const user = String(x.userId || "").toUpperCase();
    const cust = String(codeCustomerMap[code] || x.customer || "").toUpperCase();
    return code.includes(q) || user.includes(q) || cust.includes(q);
  });

  const tb = $("histTbody");
  if(!filtered.length){
    tb.innerHTML = `<tr><td colspan="5" style="color:rgba(233,236,255,.65)">No history found.</td></tr>`;
    return;
  }

  const rows = filtered
    .sort((a,b)=> (b.redeemedAt||0)-(a.redeemedAt||0))
    .slice(0, 500);

  tb.innerHTML = rows.map(x=>`
    <tr>
      <td style="font-weight:900;letter-spacing:1px">${x.code || x._code}</td>
      <td>FREE ${x.points}</td>
      <td>${(codeCustomerMap[String(x.code || x._code || "").toUpperCase()] || x.customer || x.userId || "-")}</td>
      <td>${fmtTime(x.redeemedAt)}</td>
      <td style="text-align:right;">
        <button class="btnDel" data-del="${x._code}__${x._rid}">Delete</button>
      </td>
    </tr>
  `).join("");

  // attach delete events
  tb.querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const key = btn.getAttribute("data-del");
      const [c, r] = key.split("__");
      const found = rows.find(x => x._code === c && x._rid === r);
      if(found) deleteHistRow(found);
    };
  });
}

function loadHistoryLive(){
  onValue(ref(db, "redemptionsByCode"), (snap)=>{
    const v = snap.val() || {};
    const arr = [];

    for(const code of Object.keys(v)){
      const group = v[code] || {};
      for(const rid of Object.keys(group)){
        const item = group[rid] || {};
        arr.push({
          ...item,
          _code: code,   // untuk delete path
          _rid: rid      // untuk delete path
        });
      }
    }

    allHist = arr;
    renderHist(allHist);
  });
}
  loadHistoryLive();
  $("searchHist").addEventListener("input", ()=>renderHist(allHist));
  $("btnClearView").onclick = ()=>{
    $("searchHist").value="";
    renderHist(allHist);
  };
  // ===== Sidebar UI =====
function openSidebar(){
  $("sideOverlay").style.display = "block";
  $("sidebar").classList.add("show");
}
function closeSidebar(){
  $("sideOverlay").style.display = "none";
  $("sidebar").classList.remove("show");
}
$("btnMenu").onclick = openSidebar;
$("btnSideClose").onclick = closeSidebar;
$("sideOverlay").onclick = closeSidebar;

// ===== Prize Modal UI =====
let editingType = "NORMAL";

function renderPrizePills(){
  const arr = (prizeConfig[editingType] || []).slice().sort((a,b)=>a-b);
  $("prizePills").innerHTML = arr.map(v=>`
    <div class="pillTag">
      FREE ${v}
      <button data-del="${v}" title="Remove">‚úï</button>
    </div>
  `).join("");

  $("prizePills").querySelectorAll("[data-del]").forEach(btn=>{
    btn.onclick = ()=>{
      const val = parseInt(btn.getAttribute("data-del"),10);
      prizeConfig[editingType] = (prizeConfig[editingType]||[]).filter(x=>x!==val);
      renderPrizePills();
    };
  });
}

function openPrizeModal(){
  $("prizeOverlay").style.display = "grid";
  editingType = "NORMAL";
  $("tabNormal").classList.add("active");
  $("tabSuper").classList.remove("active");
  renderPrizePills();
}
function closePrizeModal(){
  $("prizeOverlay").style.display = "none";
}

$("sidePrize").onclick = async ()=>{
  closeSidebar();
  await loadPrizeConfig();
  openPrizeModal();
};

$("tabNormal").onclick = ()=>{
  editingType = "NORMAL";
  $("tabNormal").classList.add("active");
  $("tabSuper").classList.remove("active");
  renderPrizePills();
};
$("tabSuper").onclick = ()=>{
  editingType = "SUPER";
  $("tabSuper").classList.add("active");
  $("tabNormal").classList.remove("active");
  renderPrizePills();
};

$("prizeX").onclick = closePrizeModal;
$("prizeCancel").onclick = closePrizeModal;
$("prizeOverlay").addEventListener("click",(e)=>{
  if(e.target === $("prizeOverlay")) closePrizeModal();
});

$("prizeAdd").onclick = ()=>{
  const val = parseInt(($("prizeInput").value||"").trim(),10);
  if(!Number.isFinite(val) || val<=0) return toast("Enter valid number (e.g. 100)");
  const arr = prizeConfig[editingType] || [];
  if(arr.includes(val)) return toast("Prize already exists");
  arr.push(val);
  prizeConfig[editingType] = arr.sort((a,b)=>a-b);
  $("prizeInput").value = "";
  renderPrizePills();
};

$("prizeSave").onclick = async ()=>{
  prizeConfig = {
    NORMAL: cleanPrizeList(prizeConfig.NORMAL),
    SUPER:  cleanPrizeList(prizeConfig.SUPER)
  };

  await set(PRIZES_REF, prizeConfig);

  // refresh dropdown ikut tab yang dipilih
  renderPointsOptions(prizeType);

  closePrizeModal();
  toast("Prize settings saved!");
};
const STATS_REF = ref(db, "stats/daily");

function pad2(n){ return String(n).padStart(2,"0"); }
function toDateKey(d){ return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`; }
function startOfDay(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function endOfDay(d){ const x=new Date(d); x.setHours(23,59,59,999); return x; }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }

function filterCodesByType(list, type){
  if(type === "ALL") return list || [];
  return (list || []).filter(x => String(x.prizeType||"").toUpperCase() === type);
}

function calcTotalsFromCodes(list){
  const customers = new Set();
  let totalPrize = 0;
  for(const x of (list||[])){
    const c = String(x.customer||"").trim();
    if(c) customers.add(c.toUpperCase());
    totalPrize += Number(x.points||0);
  }
  return {
    totalCustomers: customers.size,
    totalPrize,
    totalCodes: (list||[]).length
  };
}

function updateSummaryUI(){
  const sel = $("prizeFilter");
  if(!sel) return;

  const type = sel.value || "ALL";
  const filtered = filterCodesByType(allCodes, type);
  const totals = calcTotalsFromCodes(filtered);

  $("sumCustomers").textContent = totals.totalCustomers;
  $("sumPrize").textContent = totals.totalPrize;
  $("sumCodes").textContent = totals.totalCodes;

  $("sumHint").textContent = `Summary based on Active Promo Codes (${type}).`;
}
initPrizeFilterCustomSelect();
refreshPrizeFilterCustomSelect();
$("prizeFilter")?.addEventListener("change", updateSummaryUI);

// ‚úÖ panggil summary setiap kali renderCodes dipanggil
const _renderCodes = renderCodes;
renderCodes = function(list){
  _renderCodes(list);
  updateSummaryUI();
};

// ------------------------------
// SAVE SNAPSHOT (BY CREATED TODAY)
// ------------------------------
function buildSnapshotForDate(dateObj){
  const s = startOfDay(dateObj).getTime();
  const e = endOfDay(dateObj).getTime();

  const codes = (allCodes||[]).filter(x=>{
    const t = Number(x.createdAt||0);
    return t >= s && t <= e;
  });

  const normalCodes = codes.filter(x => String(x.prizeType||"").toUpperCase()==="NORMAL").length;
  const superCodes  = codes.filter(x => String(x.prizeType||"").toUpperCase()==="SUPER").length;
  const totals = calcTotalsFromCodes(codes);

  return {
    dateKey: toDateKey(dateObj),
    createdAt: Date.now(),
    totalCustomers: totals.totalCustomers,
    totalPrize: totals.totalPrize,
    totalCodes: totals.totalCodes,
    normalCodes,
    superCodes
  };
}

async function saveSnapshotForDate(dateObj){
  const payload = buildSnapshotForDate(dateObj);
  await set(ref(db, `stats/daily/${payload.dateKey}`), payload);
}


async function saveYesterdaySnapshot(){
  const y = addDays(new Date(), -1);
  await saveSnapshotForDate(y);
  toast("Auto-saved yesterday snapshot!");
}



// auto schedule at midnight
function scheduleMidnightJob(){
  const now = new Date();
  const next = new Date(now);
  next.setHours(24,0,0,0);
  const ms = next.getTime() - now.getTime();

  setTimeout(async ()=>{
    try{
      await saveYesterdaySnapshot();
    }catch(e){
      console.error(e);
    }finally{
      scheduleMidnightJob();
    }
  }, ms + 800);
}
scheduleMidnightJob();

// ------------------------------
// TOTALS HISTORY TABLE
// ------------------------------
let statsDailyArr = [];

function renderStatsRows(rows){
  const tb = $("statsTbody");
  if(!tb) return;

  if(!rows.length){
    tb.innerHTML = `<tr><td colspan="6" style="opacity:.7">No stats yet.</td></tr>`;
    return;
  }

  const sorted = rows.slice().sort((a,b)=> String(b.dateKey).localeCompare(String(a.dateKey)));

  tb.innerHTML = sorted.map(r=>`
    <tr>
      <td style="font-weight:900">${r.dateKey || "-"}</td>
      <td>${Number(r.totalCustomers||0)}</td>
      <td>${Number(r.totalPrize||0)}</td>
      <td>${Number(r.totalCodes||0)}</td>
      <td>${Number(r.normalCodes||0)}</td>
      <td>${Number(r.superCodes||0)}</td>
    </tr>
  `).join("");
}

function getRangeByPreset(preset){
  const now = new Date();
  const todayS = startOfDay(now);
  const todayE = endOfDay(now);

  if(preset==="today") return [todayS, todayE];
  if(preset==="yesterday"){
    const y = addDays(now,-1);
    return [startOfDay(y), endOfDay(y)];
  }

  if(preset==="thismonth"){
    const s = new Date(now.getFullYear(), now.getMonth(), 1);
    return [startOfDay(s), todayE];
  }
  if(preset==="lastmonth"){
    const s = new Date(now.getFullYear(), now.getMonth()-1, 1);
    const e = new Date(now.getFullYear(), now.getMonth(), 0);
    return [startOfDay(s), endOfDay(e)];
  }

  // Mon-Sun week
  const day = (now.getDay()+6)%7;
  const mon = addDays(todayS, -day);
  const sun = addDays(mon, 6);

  if(preset==="thisweek") return [startOfDay(mon), endOfDay(sun)];
  if(preset==="lastweek"){
    const lastMon = addDays(mon, -7);
    const lastSun = addDays(lastMon, 6);
    return [startOfDay(lastMon), endOfDay(lastSun)];
  }

  return [todayS, todayE];
}
function getLiveTodayRow(){
  const today = new Date();
  const live = buildSnapshotForDate(today);
  return {
    ...live,
    dateKey: toDateKey(today) + " (Today)"
  };
}
let activePreset = "today";

function setActiveChip(preset){
  activePreset = preset;

  document.querySelectorAll("#presetRow .chipBtn").forEach(b=>{
    b.classList.toggle("active", b.dataset.preset === preset);
  });

  const [s,e] = getRangeByPreset(preset);
  $("rangeFrom").value = toDateKey(s);
  $("rangeTo").value   = toDateKey(e);

  applyStatsFilter();
}

function getRangeFromInputs(){
  const fromV = $("rangeFrom").value;
  const toV   = $("rangeTo").value;
  if(!fromV || !toV) return null;

  const s = startOfDay(new Date(fromV));
  const e = endOfDay(new Date(toV));
  if(s > e) return null;

  return [s,e];
}

function applyStatsFilter(){
  const range = getRangeFromInputs();
  if(!range){
    renderStatsRows([]);
    return;
  }

  const [s,e] = range;

  let rows = statsDailyArr.filter(r=>{
    const d = new Date(String(r.dateKey||"") + "T00:00:00");
    return d >= s && d <= e;
  });

  // ‚úÖ show TODAY live jika range cover hari ini
  const todayS = startOfDay(new Date());
  const todayE = endOfDay(new Date());
  const coverToday = (s <= todayS && e >= todayE);
  if(coverToday){
    const todayKey = toDateKey(new Date());
    rows = [getLiveTodayRow(), ...rows.filter(x => String(x.dateKey||"").slice(0,10) !== todayKey)];
  }

  renderStatsRows(rows);
}

function refreshTotalsHistoryLive(){
  applyStatsFilter();
}
// click preset chips
document.querySelectorAll("#presetRow .chipBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    setActiveChip(btn.dataset.preset);
  });
});

// bila user ubah date manual ‚Üí auto filter (tanpa apply)
$("rangeFrom").addEventListener("change", ()=>{
  document.querySelectorAll("#presetRow .chipBtn").forEach(b=>b.classList.remove("active"));
  applyStatsFilter();
});
$("rangeTo").addEventListener("change", ()=>{
  document.querySelectorAll("#presetRow .chipBtn").forEach(b=>b.classList.remove("active"));
  applyStatsFilter();
});
function initTotalsHistory(){
  // tunggu element wujud dulu
  if(!$("rangeFrom") || !$("rangeTo") || !document.querySelector("#presetRow .chipBtn")){
    setTimeout(initTotalsHistory, 80);
    return;
  }
  setActiveChip(activePreset || "today");
}

// bila page siap (refresh terus auto render)
window.addEventListener("DOMContentLoaded", initTotalsHistory);
setTimeout(initTotalsHistory, 200); // fallback kalau browser lambat

onValue(STATS_REF, (snap)=>{
  const v = snap.val() || {};
  statsDailyArr = Object.keys(v).map(k => v[k]).filter(Boolean);
  setActiveChip(activePreset || "today");
});
</script>
</body>
</html>
